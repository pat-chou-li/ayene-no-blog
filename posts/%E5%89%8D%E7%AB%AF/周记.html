<!DOCTYPE html><html lang="en" data-beasties-container><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.svg"><script>!function(){const e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("vueuse-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script><style type="text/css">:root{color-scheme:light dark;--va-c-bg:#fff}html{background-color:var(--va-c-bg)}</style><script>const locale=localStorage.getItem("valaxy-locale")||"zh-CN";document.documentElement.setAttribute("lang",locale)</script><script type="module" async crossorigin src="/ayene-no-blog/assets/app.5Pc5wqE0.js"></script><link rel="modulepreload" crossorigin href="/ayene-no-blog/assets/framework.BWK1Zvdg.js"><link rel="modulepreload" crossorigin href="/ayene-no-blog/assets/chunks/@vueuse/motion.CDGXpttC.js"><link rel="modulepreload" crossorigin href="/ayene-no-blog/assets/chunks/vue-router.DlUPz4t8.js"><link rel="modulepreload" crossorigin href="/ayene-no-blog/assets/chunks/dayjs.BldX5ftQ.js"><link rel="modulepreload" crossorigin href="/ayene-no-blog/assets/chunks/vue-i18n.lF0SUo7_.js"><link rel="modulepreload" crossorigin href="/ayene-no-blog/assets/chunks/pinia.BYsrTFz1.js"><link rel="modulepreload" crossorigin href="/ayene-no-blog/assets/chunks/nprogress.DxEoPAls.js"><link rel="stylesheet" crossorigin href="/ayene-no-blog/assets/app.B3NQSKti.css"><link rel="stylesheet" crossorigin href="/ayene-no-blog/assets/group-icons.CNuSYZDE.css"><link rel="modulepreload" crossorigin href="/ayene-no-blog/assets/post.BIZmRJsi.js"><link rel="stylesheet" href="/ayene-no-blog/assets/group-icons.CNuSYZDE.css"><link rel="modulepreload" crossorigin href="/ayene-no-blog/assets/周记.B7WCHjj0.js"><title>周记 - ayane no blog</title><script id="check-mac-os" async>document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap"><meta property="og:locale:alternate" content="en"><meta name="description" content="我从来没有觉得学图形学开心过。"><meta property="og:description" content="我从来没有觉得学图形学开心过。"><meta property="og:locale" content="zh-CN"><meta property="og:site_name" content="ayane no blog"><meta property="og:title" content="周记"><meta property="og:image" content="/favicon.svg"><meta property="og:type" content="website"><meta property="og:url" content="https://pat-chou-li.github.io/ayene-no-blog/"><link rel="icon" href="/favicon.svg" type="image/svg+xml"><meta name="generator" content="Valaxy 0.26.3"><meta name="theme-color" content="#fff"><meta name="msapplication-TileColor" content="#fff"><meta name="twitter:card" content="summary_large_image"></head><body><div id="app" data-server-rendered="true"><!--[--><!--[--><!--[--><!----><!----><div class="yun-page-header-gradient" style="--gradient-from:161 196 253;--gradient-to:194 233 251"></div><!----><!----><!----><canvas class="fireworks"></canvas><!--[--><div class="yun-bg"></div><!--]--><div class="yun-page-loading" absolute left-0 right-0 bottom-0 top-0 flex justify="center" items-center z-10 bg="$va-c-bg" data-v-673bc094><div class="spinner" data-v-673bc094></div></div><a href="#" class="back-to-top yun-icon-btn bg-$va-c-bg-soft shadow-md"><div class="size-8" i-ri-arrow-up-s-line></div><svg class="progress-circle-container" viewBox="0 0 100 100"><circle stroke-dasharray="301.59289474462014 301.59289474462014" stroke-dashoffset="301.59289474462014" stroke="currentColor" stroke-width="2" stroke-linecap="round" class="progress-circle" cx="50" cy="50" r="48" fill="none"/></svg></a><!-- TODO --><!-- <YunDock /> --><!--]--><!--[--><!--]--><!----><!--]--><!--[--><div flex="~" class="w-full m-auto justify-center items-start gap-4 mt-12 md:mt-24"><!--[--><!----><main class="yun-main lt-md:w-full" flex="~ center"><!--[--><div class="content w-full md:w-3xl lg:w-2xl xl:w-2xl 2xl:w-4xl" flex="~ col grow" p="lt-md:0"><div class="yun-card flex-center rounded-2 relative" flex="col" min-h="100px" bg="$va-c-bg-light" m="0" style><!----><!----><!--[--><div class="mt-8 mb-4"><!--[--><header class="post-header"><h1 p="2" text="2xl center" font="serif black" style="" class="post-title flex-center"><!----><span inline-flex class="leading-none">周记</span></h1></header><!--]--></div><!--[--><!--[--><!--[--><!--[--><!----><!----><!----><div flex="~ center" text="sm" class="flex-col gap-2! post-meta gap-4"><div class="post-time flex items-center gap-4"><span class="posted-time inline-flex-center gap-1" title="发表于2025-04-23 00:00:00"><div class="inline-block" i-ri-calendar-line></div><time class="op-80">2025-04-23</time></span><span class="edited-time inline-flex-center gap-1" title="更新于2025-08-22 09:02:38"><div i-ri-calendar-2-line></div><time class="op-80">2025-08-22</time></span></div><!--[--><!--]--><div class="inline-flex-center gap-4"><!----><!----></div></div><!--]--><div class="inline-flex mt-2" text="sm" py="1"><a href="/ayene-no-blog/categories?category=%E5%89%8D%E7%AB%AF" class="transition post-category inline-flex-center text-xs border-$va-c-divider" px-2 h="7" border rounded-full hover="bg-blue-500 text-white"><div m="x-1" inline-flex i-ri-folder-2-line></div><span>前端</span></a><span mx="2"></span><div class="post-tags inline-flex" items="center" gap="1" flex="wrap 1" justify="end"><!--[--><a href="/ayene-no-blog/tags/?tag=%E5%89%8D%E7%AB%AF" class="transition post-tag inline-flex-center text-xs border-$va-c-divider" px-2 h="7" rounded-full border hover="bg-blue-500 text-white"><span>前端</span></a><a href="/ayene-no-blog/tags/?tag=b%E7%AB%99" class="transition post-tag inline-flex-center text-xs border-$va-c-divider" px-2 h="7" rounded-full border hover="bg-blue-500 text-white"><span>b站</span></a><!--]--></div></div><!--]--><!--]--><!--]--><div p="x-4 b-8" class="sm:px-6 lg:px-12 xl:px-16" w="full"><!--[--><!--]--><!--[--><!-- <Transition appear> --><article class="markdown-body"><!--[--><!----><!----><!--[--><!--]--><!--[--><h2 id="小需求" tabindex="-1">小需求 <a class="header-anchor" href="#小需求" aria-label="Permalink to &quot;小需求&quot;">​</a></h2><h3 id="续播时增加从头播放能力" tabindex="-1">续播时增加从头播放能力 <a class="header-anchor" href="#续播时增加从头播放能力" aria-label="Permalink to &quot;续播时增加从头播放能力&quot;">​</a></h3><p>在播放器自动定位至xx秒时，提供一个”从头播放“按钮，触发seek：0事件</p><h3 id="弹幕举报面板更新" tabindex="-1">弹幕举报面板更新 <a class="header-anchor" href="#弹幕举报面板更新" aria-label="Permalink to &quot;弹幕举报面板更新&quot;">​</a></h3><p>播放页负责写iframe，播放器端监听message事件，判断来源和action，给出回调（toast，屏蔽弹幕等）</p><div class="language-typescript"><button title="Copy code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// iframe文档: https://info.bilibili.co/pages/viewpage.action?pageId=996237971</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> { IHttpDmReportRecall, IHttpDmReport, IHttpDmReportSubmitRecall } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '@jsc/http'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> { genElement, showElem, hideElem } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '@jsc/utils'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> DmReportConfig</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">    ppx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    hide</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">fromShow</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    submit</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">?:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">res</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> IHttpDmReportSubmitRecall</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">    domEle</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> HTMLElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> IHttpDmReport</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> IDomObject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">    wrap</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> HTMLElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">    iframe</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> HTMLIFrameElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> ReportV2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> template</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> IDomObject</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> config</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> DmReportConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    static</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> reported</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">[] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> []; </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 已经举报的弹幕id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    public</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> domEle</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> HTMLElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    boundMessageHandler</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> MessageEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">IHttpDmReportRecall</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> void</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    get</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> wrap</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.template.wrap;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    constructor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        private</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70"> container</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> HTMLElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">        config</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> DmReportConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    ) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.config </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> config;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.container.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">appendChild</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">genElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">createTpl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">()));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.template </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            wrap: &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">HTMLElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.container.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">querySelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">`.${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">ppx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">}-report-wrap`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            iframe: &lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">HTMLIFrameElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.container.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">querySelector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">`.${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">ppx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">}-report-iframe`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        };</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.domEle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> config.domEle;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.boundMessageHandler </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.messageHandler.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">bind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    private</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> createTpl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> ppx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.config.ppx;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> reportCfgParams</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> IHttpDmReport</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            aid: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.config.aid,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            cid: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.config.cid,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            dmcontent: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.config.dmcontent,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            dmid: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.config.dmid,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            from_spmid: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.config.from_spmid,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            scene: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.config.scene,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        };</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> reportCfgParamsJSON</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> encodeURIComponent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(reportCfgParams));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> `&lt;div class="${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">ppx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">}-report-wrap"&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">                &lt;iframe class="${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">ppx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">}-report-iframe ${</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">config</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">scene</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> ===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'normal'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> &amp;&amp;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> `${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">ppx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">}-report-iframe-shadow`}"</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">                src="https://www.bilibili.com/york/danmakureport/?report_cfg=${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">reportCfgParamsJSON</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">}"</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">                width="308"</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">                height="388"</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">                frameborder="0"</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">                &gt;&lt;/iframe&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">            &lt;/div&gt;`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    messageHandler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> MessageEvent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">IHttpDmReportRecall</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">&gt;) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (e.origin.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">indexOf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'www.bilibili.com'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">===</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> ||</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.template.iframe.contentWindow </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> e.source) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> recall</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> e.data;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (recall.action </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'close'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">hide</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">destroyIframe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (recall.action </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'submit'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">hide</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">destroyIframe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'ReportV2: submit recall'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, recall);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.config.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">submit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">?.(recall);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">warn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'ReportV2: Unknown action'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, (recall </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">as</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">).action);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    hide</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        window.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">removeEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'message'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.boundMessageHandler);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        hideElem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.template.wrap);</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.config.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">hide</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">?.();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    show</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        window.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">addEventListener</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'message'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.boundMessageHandler);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">        showElem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.template.wrap);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    destroyIframe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.template.iframe) {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.template.iframe.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.template.iframe </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.template.wrap.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.template </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">    dispose</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        ReportV2.reported </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> [];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><ul><li>pre环境支持按秒显示：格式化内核传出的currentTime</li><li>弹幕hover问题排查：</li></ul><h3 id="弹幕hover问题排查" tabindex="-1"><strong>弹幕hover问题排查</strong> <a class="header-anchor" href="#弹幕hover问题排查" aria-label="Permalink to &quot;**弹幕hover问题排查**&quot;">​</a></h3><figure><img src="/ayene-no-blog/assets/c0b97b43ce738103ba4d40d245229adb.CZ8XYjWO.png" alt="c0b97b43ce738103ba4d40d245229adb" loading="lazy" decoding="async"></figure><p>问题：弹幕可以hover的位置和弹幕实际位置偏差了约40~60px</p><p>原因：hover事件通过鼠标位置和danmaku-x内部提供的弹幕(x, y)坐标来触发, 主要问题出在danmaku-x提供的(x，y)并不准确上。</p><p>性能考虑，实际上xy是通过计算得到的，而并非通过DOM方法，通过初始化时规定速度和时间来计算位置。但是在赋值css属性（来规定动画和弹幕初始位置）的时候，出现了一些魔法数字，+50， -10等导致了实际位置的偏移，但记录的x并没有记录这些变更。</p><figure><img src="/ayene-no-blog/assets/27b1968376ceaeb3cb81129add8aa182.DAvrF7K9.png" alt="27b1968376ceaeb3cb81129add8aa182" loading="lazy" decoding="async"></figure><p>修改后偏移控制在5px以内，仍有误差，排查下来可能有以下原因：</p><ul><li>弹幕宽度也是计算的，和实际尺寸有差距</li><li>弹幕位置通过时间*速度得到，但是内存中记录的时间，和实际的时间约有2帧偏差，导致了0.016s*speed的偏差（实际开始动画的时间和理论开始动画的时间不一致）</li></ul><h3 id="主站-bilibili-com-和游戏页-biligame-com-跨域-导致的登录态问题" tabindex="-1"><strong>主站（*.bilibili.com）和游戏页（*.biligame.com）跨域，导致的登录态问题</strong> <a class="header-anchor" href="#主站-bilibili-com-和游戏页-biligame-com-跨域-导致的登录态问题" aria-label="Permalink to &quot;**主站（\*.bilibili.com）和游戏页（\*.biligame.com）跨域，导致的登录态问题**&quot;">​</a></h3><h4 id="表现" tabindex="-1">表现: <a class="header-anchor" href="#表现" aria-label="Permalink to &quot;表现:&quot;">​</a></h4><p>从主站进入biligame时，内联的播放器无法获取到登录态，检查network接口发现cookie没有被携带。</p><p>从biligame登录时，内联的播放器可以获取到登录态。</p><figure><img src="/ayene-no-blog/assets/1828aa467b4262cef94f995d35168877.DSIqHWfG.png" alt="1828aa467b4262cef94f995d35168877" loading="lazy" decoding="async"></figure><h4 id="定位" tabindex="-1">定位： <a class="header-anchor" href="#定位" aria-label="Permalink to &quot;定位：&quot;">​</a></h4><figure><img src="/ayene-no-blog/assets/449e29a8807ffe347930d8b6277a5b54.COpyp70T.png" alt="449e29a8807ffe347930d8b6277a5b54" loading="lazy" decoding="async"></figure><figure><img src="/ayene-no-blog/assets/090e345d6a70566002f09bed41754948.Dxzg_ug9.png" alt="090e345d6a70566002f09bed41754948" loading="lazy" decoding="async"></figure><p>单从前端来看，是因为请求域名（请求登录态接口）在*.bilibili.com，而当前位于*.biligame.com，并且cookie中Domain为*.bilibili.com的DedeUserID没有配置samesite=none，导致不能自动携带cookie。</p><h4 id="解决" tabindex="-1">解决 <a class="header-anchor" href="#解决" aria-label="Permalink to &quot;解决&quot;">​</a></h4><p>目前暂时的解决方案是：服务端短期修改set-cookie为samesite=none</p><p>日后：可能需要播放器侧根据不同域名请求不同接口，需要服务端配合修改，待产品提单。</p><h3 id="弹幕压号部分场景失效" tabindex="-1">弹幕压号部分场景失效 <a class="header-anchor" href="#弹幕压号部分场景失效" aria-label="Permalink to &quot;弹幕压号部分场景失效&quot;">​</a></h3><figure><img src="/ayene-no-blog/assets/c2ff1eae921d5dfe76c39101f73c9c75.CtHeH18g.png" alt="c2ff1eae921d5dfe76c39101f73c9c75" loading="lazy" decoding="async"></figure><p>弹幕压号由插件DmDelivery显示，仅community helper安装了该插件，因此仅UGC场景生效。</p><h2 id="大需求" tabindex="-1">大需求 <a class="header-anchor" href="#大需求" aria-label="Permalink to &quot;大需求&quot;">​</a></h2><h3 id="高能进度条性能优化" tabindex="-1">高能进度条性能优化 <a class="header-anchor" href="#高能进度条性能优化" aria-label="Permalink to &quot;高能进度条性能优化&quot;">​</a></h3><p>时间 | 2025.7.07~？</p><h4 id="逻辑梳理" tabindex="-1">逻辑梳理 <a class="header-anchor" href="#逻辑梳理" aria-label="Permalink to &quot;逻辑梳理&quot;">​</a></h4><h6 id="数据结构" tabindex="-1"><strong>数据结构</strong> <a class="header-anchor" href="#数据结构" aria-label="Permalink to &quot;**数据结构**&quot;">​</a></h6><p>zebraPath：表示已播放区域，维护有序无重叠区间集合zebraAreas来实现（维护代价O(n)）</p><p>clipRect：也是已播放区域，但是由[zebraStart, zebraEnd]两个变量维护，现在正在播放的区间</p><p>line：当前播放时间上会画一条竖线，实时获取currentTime实现</p><h6 id="更新时间" tabindex="-1"><strong>更新时间</strong> <a class="header-anchor" href="#更新时间" aria-label="Permalink to &quot;**更新时间**&quot;">​</a></h6><p>timeupdate(约0.25s一次, 播放器事件触发):</p><p>​ ● abnormalUpadate（相比上次跳转&gt;1.5s || 回退）：触发区间插入和合并，重绘zebraPath和clipRect，n+1</p><p>​ ● nomralUpdate：只重绘clipRect</p><p>以上操作均会重绘line，即每0.25s获取当前currentTime并更新line svg</p><p>seek:</p><p>​ ● 等同abnormalUpdate：触发区间插入和合并，重绘zebraPath和clipRect，n+1</p><h5 id="其他细节" tabindex="-1"><strong>其他细节</strong> <a class="header-anchor" href="#其他细节" aria-label="Permalink to &quot;**其他细节**&quot;">​</a></h5><p>​ ● 维护有序区间可修改为二分插入，但是n通常过小（用户每次seek+1），理论上无明显优化</p><p>​ ● svg dom节点较少（fillRect+playRect+line），且有独立图层，每次timeUpdate或seek都会触发svg内部的重排重绘，但是每次的代价较低?</p><p>​ ● PLAYER_HEARTBEAT的时候，会将有序区间存储进 db，约15s一次，也会执行区间合并后再加入</p><h5 id="性能表现" tabindex="-1"><strong>性能表现</strong> <a class="header-anchor" href="#性能表现" aria-label="Permalink to &quot;**性能表现**&quot;">​</a></h5><p>以下实验均以5s周期，seek10次，再静置70s</p><p><a href="https://fe-perfcat.bilibili.co/utils/shorten/TYtDVA" target="_blank" rel="noreferrer">关闭高能进度条 vs 开启高能进度条</a></p><figure><img src="/ayene-no-blog/assets/image-20250722162914586.DcOxsGBQ.png" alt="image-20250722162914586" loading="lazy" decoding="async"></figure><p>timeUpdate中，其实不止有高能进度条的绘制事件，还有别的导致重排重绘的事件，如果考虑这件事，实际上只优化高能进度条并不能减少重绘重排次数，以开启进度条为例（但这里去除了小电视）：</p><p><a href="https://fe-perfcat.bilibili.co/utils/shorten/eMHK7w" target="_blank" rel="noreferrer">关闭高能进度条 vs 开启高能进度条 (均不关闭进度条)</a></p><figure><img src="/ayene-no-blog/assets/image-20250722162944526.B1TA5re1.png" alt="image-20250722162944526" loading="lazy" decoding="async"></figure><p>此外也用time timeEnd收集了维护区间算法的性能表现，n = 10, cpu throttle = 6的前提下</p><figure><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAATsAAAAnCAYAAABwv++TAAAAAXNSR0IArs4c6QAAFRZJREFUeF7t3QOQJUkTB/Da72xbe7Zt27Zt27btu92zbcZZe7Zt21/8KqImanof+s3NLGY7IyZm5r1GVVbVP/+Z1Z3Zo2fPnv+GSioNVBqoNNCNNfDuu++GHq2C3bDDDhtV8ssvv7SkmmGGGSb8+uuvLZ3T7GBt+e2338I///zT7ND4vTb8+eef4a+//ip1fDqoR48e4d9/K5vQktKqgysNDEAa6BDYnX/++eGjjz4KBx54YN2u/O9//wsjjDBC+OOPP+Ixo446arjwwgvD7rvvHt54442284AO8BlttNHCRRddFF5++eWG6unTp0+46qqr2o657LLLwltvvRUOOOCAsOKKK4aJJ5647bshhxwyTDLJJGGrrbZq++zqq68OZ555Znj//ffDTDPNFIYeeuj4M9ZYY4XRRx89tuP2228PV1xxRds5+nLttdeGyy+/vN29u2IcBx988DDEEEN0yCgMP/zw4aeffur0Zo000kjh+++/r3lduqG7r776Ko5jLvSqP53dpmY60l5SbLP2MHbffvttp+uouuCAr4FSYLfmmmuGZZZZpg20hhpqqPDjjz/WnMRHH310eOWVV8LCCy8c9t5773ZsCDsiOUP64IMPwuabbx4mnXTSCEL33ntvTa0NNthg4e+//w4vvvhiuO222+IxQKFnz57htNNOC/vss08ErymnnLLtfKxviimmCEsssURfYKf9QBDYuoa23XTTTREEX3rppUAxucw333xh//33D/p33333dcnI6sOCCy4Y2/Lpp5/G9pVhwtp/0kknBf2l29NPPz32JYmx23jjjcOII44Yx4TBIGOPPXbo1atXu7489NBD4dBDD42fOc/YDDfccFFPDzzwQDjmmGPid9p40EEHhbnmmiv+7b7bbbddePPNNwOwYQinnXba+N0XX3wRtt566zhnyPTTTx+23377MNFEE4VbbrklnHrqqX3pc955543XMBa77LJL2/eNdDTNNNOEI488MgIaefXVV8OOO+4Y28NA6z/54YcfomF1b3LCCSeE6aabrl0bllpqqdLeQpdMhuqina6BUmAHMGacccZ488022yz+Pu+882o25p577omWE9jtsMMOYY011oh/F2WcccYJjz76aFwcBNiZ9NiZhXHuuee2LfTxxhsvXHDBBWGLLbaIYJQE6G2zzTZhnnnmiQv4tddea3cbzBIjA3aTTz55OPnkkyPTII899lh45pln4t+rrLJK0B4gQbjFd911V19txkoXX3zxduDZWSMCTLFTev3555/jIn388cfjZ80E49SvvfbaKx6vL6uuumoEF/o3ZsDT5/vuu2946qmn4iX9f/HFF0e9f/jhh/Gzjz/+OHz55ZfxegATg99zzz3D6quvHlZbbbWwySabxM823XTTeG3jwkAxNM8++2z4+uuv274DhgzUwQcfHO+pbWOMMUa49NJLIxPEos2XY489tl0XGbHrrrsuYObmBxAljXSEYQIv13U/LHOyySaLhsk9GSrAbm7Skzm1wgorRBA/5ZRToudx3HHHxfsIibzwwgvN1F59P5BpoBTYpT4ltgZU3nnnnbaujj/++NE1Peecc9o+S2BnobG2ubC8XJ8rr7wyWtwc7NZee+244C02YGkRmqQYzpZbbtnuOgnsWPSddtqpjTkAORP4wQcfbAM7C8gEP+OMM+Jnn3/+eVysBMMhn332WfwNJLbddtu+htIiWWSRRSIDvf766+sONUa26KKLxgULiMoIdsHlXmmllSKY7rbbbnEhJkZd7xoJPBKb46ZjML17944/jAjwpk8GpBbYMS5vv/12X2N04403BmECLIiL7296BSr6jzlhWkW55JJLYjyXcSL6xmAut9xykXUZL4bG+N1///19gd1+++0XjROwA54J7BrpiJ7MgbXWWit88803DVU+22yzhSOOOCIC4BNPPBH7xFspzq9m43bIIYdE/Y4yyijh+eefD1NNNVVkjcaOwbAudt1119h3DPe5556rqa9m96m+7xwNlAa7WWedNU4Qg2ZgDWqSWWaZJbCsWFkOjCYphkG4mkAEo+Ia3X333XGSJUnMzqQFTNxFbhA3houx7rrrRqudSwI7wOI8TIJwf8TdxPYSs0vnpZgdpgEUgDEwmHDCCSPL4RI+8sgjkeEUxSLXb24dUKq3YQHc6evOO+8Mxx9/fKmRAhAYnQWrzRYL5pW74LUulBauhbrYYotFtsLlx5oPO+ywtlO4jPXALvXjk08+CYAm9f3EE0+MAKzf2DNgxe7oS98YPePmfAyKEfAdcMTosD9inIUXllxyyb7Grwh2jnM8oDzqqKPagV0jHdGbecBgGcv33nsv9vfpp5/uS21c6OWXX76N/bofoNIPjPCaa66JfWgm5gvwFlqZf/75o3ED6PR11llnhbPPPjuMOeaYcQ6Y0zPPPHME/kr6jwZKgR3LxNXhcnDjDOZ3333X1mJxppFHHrkN2Hyx8sorR9dnww03jIsPQGAB4jXcHi4l4EwbFDnYpQsn0LAIN9poo740lIMdlpZca66WCVsEOxPu1ltvjdf5/fffozUHplwb7E4bxx133Ng+YJvL3HPPHd0j/bGIuGL1WBvgBQ4AQQysjAA4LrpgPoDBei3K5I7WuwYAwR4sduDEVcRAbdpwu5PUAjuxLLoC/HPMMUcEI0H9xHiNYdrcSTFNzNh40iNwoAffrbPOOhEg6GS99dYL66+/flzsjnENxyy77LLtNjGKzM4xxowxBdSulTO7RjraY489wpxzzhk9AW0yTtxk4JNLAlPtT8bWPDUfuK/A3Bww9wBxIwF2PJqbb745usDGHcNmLLA+39sUMTbCCJX0Xw2UAjuuJrcPWIllsZr5DhuraKLkEwvTEMcRCwGEJG1Q+NsiSCzRoiyCnfMtdAzB4rJwTPZccrCziZJidtoDLHKwA8ja757cL/EozMMi9Rs75bpirxhk0QJb5Ky+WJpzME1MttVHWOoNtwVqg8EPtik+ZVMBADV65AVIAQasWWiBLhkj7lnaaHDPWmBXbAvAwA7pXb+4sRgb4McgDz/88LgRQu/mgXhacvcBnXO0XR9sKgB8+jZfAHgzZkevQMoY2MXXHv2yKcIoNdKRfmt7iikyqhgVg/H666/HrgpjMFQmfa0whWOAk34DXPdvBnba5XieCxYO7BgMc2322WePTBn70x/MNN/l779Lf9C7eymwyx89MMkBCYubxCTDjFjFJGJDic2lz0x2i4ElBUjYHZfWjmwCuw022CBOUtfjFt1www0RXDC7IuDlYMdttFlBTDzB8hzs9MFkx85cF4hqIwAzYT22wf3B9ixwLlQSTAcgajvmwGUHlnSRu+LpeOwBG7YrXYyF1ZtidDH11FNHloBFY2h2OlPMTswNWyCJPfg77agCGu30W9vyeGhZsNM/12A4hA7EtLAS/SD0LXCPOfrbY0KJPXLbhAWMVZK0Swt0XQ9TLBqr3I0FQLnBZOSI3VxssZGOMEk/2o6pC0eIIae4XHq0STzPWNYzUtqM9ZWJr2FujcAu9dXcBv7ikDbDOvtRnEEPtjrW41Jgl1/aAhcXyQfMYJo83JQkrJiJnDYgfJ6DnQC3uFra1Ehgx3q7Dtcsp/4s/gILLNAWB0qLD8CJ1ZjkiQGZsEVml9qVYnbAjtVPu4pYKGtsYWIiidlxX8UCi49zJLe2CCru05GYnfAA4MCcuJUWUgIW18xdcO3MY1FcdsyajuiDnm30JINEt4DcYycMhutyc7FHOrNZgLkJrAMWBigxHIuegbAxY8MobVBgX3TmHOBvR1XMCnOymYHJuY/zsGHjDRCJWCTj4lqMkucvuX7Fh9SLbmwjHfEgsCaxSu68HWQxsqWXXjoyTfOKwaA7Lisxv9IjSNiZOazvCy20UDtGWG9pNQM7wGaTLO1Qm6M8AvHYSvq9BloGO3EoCynf8WKx/WBlxG6oBcjK5wwwPe+F2Zmc+TUsSK5iLaaUq8XiTM/ZJWbnUQgsMj3AbBdPsN+Or0cjcveJK4z5AQfMzgK1iLTZ3/ohZsd1Ah4mJ7ewVrsApQlsIWOLSQAB8LjjjjtaCkgDjPSIj40QCy89AJuDHdBKj824J9akvemxGgvbQkxS6zEaLjiXL99UAgJAIjE5bBpbp096x+TSM2/GD3BizL7jQgMS7cVg0mM82sAl1ObEpuzqAsRcsLYUT02fAzvAAGSTNNJRGi/H2r2nB+yefmptDIjx+p7RTSzSuWUf+UkPwddzYxl8GxT0Y765T7P53e8hYNC5438COxYdswE04mDYGBFH4v4kl0Ysw8KxMGw2WMRFYe3L7FxiZNwVksAOEysK9wVzAbbaIW4CgAECdw3zAHZAg+Xnvlqo3GEbMSYlFmhBp4dPa00Lu7Kul3Yp/+vUAbrcwVq7wc2uzXVzXvFNhkbnuR/33oZTevSmeLxHKIxbrVfy7NDagU0PDKdz6dR5QhS+70xppCNGwVxy37LCE5hgggniHLFJ1Jnt5T6LWZcNZ5Rtc3Vc6xpoGeyAAUudrLRnpgCQXak8kG5CpgUA5Lg8jgMuZd4KKNMVmwq2/Wstbvf0k096ixqbdH8T2yQs7pIJ5Osb0ADmZd65rd6bLTNa1TGVBvqvBloGu/7b3OrulQYqDVQa6JgGKrDrmN6qsyoNVBoYyDRQgd1ANmBVcysNVBromAYqsOuY3qqzKg1UGhjINFCB3UA2YFVzKw1UGuiYBiqw65jeqrMqDVQaGMg0UArsvMZUSaWBSgOVBgZmDXgut+UaFANzh6u2VxqoNDBoaqAUsxs0VVP1utJApYHupIEK7LrTaFZ9qTRQaaCuBgZ6sGu1lGKuCa95yb5RfK+zqC3v08oCkmd68XK8l8c769W3ao5WGqg00LUaKA12qi3ZqAAO3iv1t3ddAQYg8F6sl+LzPGGyjaTU3Hk3vLPqvDzleL8qpZjaAcC85O8FcPnj5JGrJ7KYeOE9T2Ag95r251lDOmOompUJbHSPRqUU/8t1ixlqyvTTe8UyfkiE2mqC06rkYRkNV8e0qoGWwE5CSjnHMBzpgWTDleZGDrRa7AgoSqfkt6IkKY2O9EvqROQVnPpVKUUKkhlDbjWsUFop2WQBnxRPtQTQSdcjhZFEBhajY/3Uq7LW6kA4vqtKKTa6bqOyhuo0yFYjqQNjJvdgyhbdqPygNOxSZaUECdI/SQ2VWHC9ezYreaiYjnmXiySrXVXasiNjWJ0z4GqgFNhhMQq5FF1A/xdThmN3JrU0TxaZ7+Vmk31ECiGplLBCef4Bp8y4junqUoqp7XKtpcJB8u9pQ0rZLtGifGkpi4oFK3cfkSFFvjzHpzTz+ikHnMWWElN2dKi7qpRio+s2K2toq16qezqRsksyzFQTo1H5Qfdk2OS/UzTJPJBxWs6/RvdsVvJQbkFjJudeEinXq1BCR2fdoHVeKbCjEkWLVQuTUonI5mrhP/nkk/F/SSflmUsJNDEArpM8afKLEdl1Z5hhhphjjtsq7qXOgnRKCey6spSifHsy58pbh9HlmXG1C/DKZabWgn5JCZWeMVSPQF47C5hYcOl/QJ7q3/puQCql2Kj8YKOyhqlqWSqzmEopyiosqWYr5QflPKRrY12mlGJagsWSh8DOT7PyksUlDKBlDWakGFxpu/SH0ZMV2jzF7s1hxlgaMCGLCkS7FxiWBrvkCkloSQCDIjzYUPo/WX1uYgKWpC7pzrmyqQZoAj9pyLnBXV1KUWxNER/FY6QuN6mLgqEBYYtMLYSctcrQvPPOO7erx6AWQ61iyh1Jy95VpRTLXrdY6Stl95UlGLsD/IBOCUxMr1n5QSwNKMljiN3VqrVbr25sGpdiyUNAJxuxcREvljJeyvxkYOstTX2Q6l/7ucEMlvgmN1vi1ZSaX59kRhZrlki2mCa+ey39Qa83pcFOARjuScrfn8Ai/z+BXYq/ieOpQ6G4jqy1qi7JaqzugIlk0yO5N11dSjFtpJSx1tiH4wCfQDuR4lvcCcATICIVOrCz+PKatgNSKcWyJRprAY806Vi3WF3K7ixOKwt0s/KDQE5c1ninouPFTMiNwK5WyUPVujBtRY+k0meUlKrMq6jVWsLATs0QXkOq5asmhw0mRjuBoXoayXMZ9KCg+/e4NNhhdqw9q04Ehh9++OG2lOUYU17j1KSSyhtoFNNcAxPgoM6nWgmApKtLKaahFFuTkj2BdD7EADyvpsVNxVJTCcic6RU/wxxa3XXM791VpRTLXrcW8Cj8DOSEIYA8Zq4+h4I2uTQqP2jTwSZWquqVn1cP7MqUPEwGKBUsb7RUgZkYsgpl6kCYuzJSY/vmLKOmBkaqF6FoDwAtk6W6+0NE9+lhabBLLkRiNorZkPx/kycxJyDGRQWCakTkqdNtEihBBxwUN7Gr2dWlFNOQ2XUVR8yrnqXvPIIidiOOk4tYE7fWwkhiodZzYwekUorNSjTm/cnLGub9B+zqYghh2F1XqrH4faPyg+raYmXN6sa6ZtmSh441lja67Br/F7BL57q3eW6szVvAXkn30UApsBPAFdDPRXEXTEeBkiR9+vTpa1dSZSuAmLMelluBHiX2kvSrUoqqXnFVau2ecqltTuRgh7VY5NwlbmsZsOtIzK6rSik2u26jsoY2pVQaM/76BFgYNIbLJky98oMeVxGqUJcEo7KZw/UUMyX17um7RiUPuZzCBqrJCYHYRMgrntVbls2Ynd14XohNJoaK0TPfzYdKuo8GSoEdV05191xU5gJu3IIkQM2jALm7B+xsQORgZ9Fgdqksn/P7VSnF3r17R3cFoyyKuI5+JbDzfBl2KpgtiJ2/QdGI2Q1opRQblR9sVNbQpoJxIcYP6zXmpFH5QTE+xpCYC4oa2UhIVeDq3ZPhbFTyUE1a7mcS88pjUWLBjaQZ2GHodunTvPVcoF3oSrqXBkqBnZ0p8bpcasWxfC+2Z9JyMQjA8BBxHv/wGRG4NrEUh+7qUoqp7b169YqPHYg3FsXjNDnYWbSeFzPxizt+jcDuv0yRriql2NHresPE2BVLOzYrP+h+xhTANdstbUVfdnn9aE8zkGvlugxaam8rpShbuUd1bP/VQCmw60gTscEywpp2NLDfailF7cEMgGxeoDu1U1lIizM9cmBR2UgpPjjteIyHa9aZC7mMvqpjKg1UGuiYBroM7DrWnOqsSgOVBioNdI0GKrDrGr1WV600UGlgANMAsPs/clPdfNael3oAAAAASUVORK5CYII=" alt="img" loading="lazy" decoding="async"></figure><h5 id="埋点设计" tabindex="-1"><strong>埋点设计</strong> <a class="header-anchor" href="#埋点设计" aria-label="Permalink to &quot;**埋点设计**&quot;">​</a></h5><div class="language-"><button title="Copy code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span>export interface IPBPTrack {</span></span>
<span class="line"><span>    updateClipRectCount: number; // 更新clipRect的次数</span></span>
<span class="line"><span>    updateZebraPathCount: number; // 更新zebraPath的次数</span></span>
<span class="line"><span>    updateLineCount: number; // 更新line的次数</span></span>
<span class="line"><span>    zebraAreasLength: number; // zebraAreas的长度</span></span>
<span class="line"><span>    isOpenPin?: boolean; // 是否打开高能进度条常驻</span></span>
<span class="line"><span>    isOpened?: boolean; // 是否打开高能进度条</span></span>
<span class="line"><span>}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><h5 id="总结" tabindex="-1"><strong>总结</strong> <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;**总结**&quot;">​</a></h5><p>数据结构和算法上，有一定优化空间，可从O(n)优化至O(logn)但是实际表现应该不会有明显优化。</p><p>重排和重绘上，需要同其他timeUpdate的视图更新同步优化。</p><p>埋点已写好但还未灰度发布。</p><h4 id="性能优化" tabindex="-1"><strong>性能优化</strong> <a class="header-anchor" href="#性能优化" aria-label="Permalink to &quot;**性能优化**&quot;">​</a></h4><p>根据上述探讨，主要应该对timeUpdate进行节流，综合用户体验，短视频中如果进度条绘制频率低，较容易被感知，因此应该少节流；而长视频进度条绘制频率低不易被感知，可以多节流，因此暂时采用以下节流公式：</p><p>​ ● 视频时长[0, 1min) : 维持原有方案(0.25s 绘制一次)</p><p>​ ● 视频时长[1min, 30min] : 固定为每0.5s绘制一次</p><p>​ ● 视频时长[30min, +无穷大] : 通过累积阈值节流，进度条每移动0.03%，绘制一次</p><p>​ ○ 30min的视频，每经过30min × 0.03% × 60 = 0.54s 绘制1次</p><p>​ ○ 120min的视频，每经过120min × 0.03% × 60 = 2.16s 绘制1次</p><p>此外，发现小电视图标每次移动都调用两次clientWidth计算位置，导致了额外的重排（但是performance面板体现为svg root重排+document重排，只统计为1次，样式重计算次数则额外统计2次）</p><p><strong>对于2h的视频，50次seek，每次seek至30s后，静置5s，运行perfcat得到结果：</strong></p><p>原始进度条：<a href="https://fe-perfcat.bilibili.co/utils/shorten/36DC_X" target="_blank" rel="noreferrer">https://fe-perfcat.bilibili.co/utils/shorten/36DC_X</a></p><figure><img src="/ayene-no-blog/assets/image-20250722163107329.03MIeFC-.png" alt="image-20250722163107329" loading="lazy" decoding="async"></figure><p>限频+cache：<a href="https://fe-perfcat.bilibili.co/utils/shorten/2ZbRDo" target="_blank" rel="noreferrer">https://fe-perfcat.bilibili.co/utils/shorten/2ZbRDo</a></p><figure><img src="/ayene-no-blog/assets/image-20250722163123001.bSGIFyhe.png" alt="image-20250722163123001" loading="lazy" decoding="async"></figure><p>主要指标变动：</p><p>平均cpu利用率：6.1 -&gt; 4.8 （21%↓）</p><p>每秒布局次数：3.9 -&gt; 0.6 （85%↓）</p><p>另外尝试做了限制db存储的实验，对性能几乎无影响：</p><p>限频+cache+限制db存储：<a href="https://fe-perfcat.bilibili.co/utils/shorten/N4oqoO" target="_blank" rel="noreferrer">https://fe-perfcat.bilibili.co/utils/shorten/N4oqoO</a></p><figure><img src="/ayene-no-blog/assets/image-20250722163221890.7Zc6dsx_.png" alt="image-20250722163221890" loading="lazy" decoding="async"></figure><p>平均cpu利用率为4.9，可以认为是4.8的浮动范围内。</p><h3 id="弹幕webgl-canvas性能调研" tabindex="-1">弹幕webgl canvas性能调研 <a class="header-anchor" href="#弹幕webgl-canvas性能调研" aria-label="Permalink to &quot;弹幕webgl canvas性能调研&quot;">​</a></h3><p>用pixijs实现初版滚动弹幕，在cpu throttle*6的情况下，动画非常不流畅，每次拉弹幕都会卡一下</p><figure><img src="/ayene-no-blog/assets/image-20250722180456737.DRmyQeOK.png" alt="image-20250722180456737" loading="lazy" decoding="async"></figure><p>通过跑performance面板，发现两个主要开销</p><p>使用HTMLText显示文本的情况下</p><ul><li>构造函数开销：对象池部分解决（还有部分来自设置纹理样式等开销，不同对象不一样）</li><li>纹理创建开销<ul><li>HTMLText在渲染时需要创建纹理，在创建纹理的过程需要计算整行字体的宽高以生成纹理，这里调用了measureHtmlText，其中执行了getBoundingClientRect，造成了频率极高的强制重排</li><li>HTMLText以整行文字作为纹理，并且没有缓存机制，每个实例创建一个纹理，造成了重复的创建开销。</li></ul></li></ul><p>为了解决上述问题，切换了BitmapText，有以下特性：</p><ul><li>创建纹理时，字体大小通过离线计算而非getBoundingClientRect得到，避免重绘重排开销</li><li>会创建动态图集进行纹理缓存，即<ul><li>每需要渲染一个新的字体，就在已有的纹理上移动一格uv-offset，然后绘制并存储，若一张图集满了则创建新纹理，有一次绘制开销。</li><li>若是绘制已有字体，则切换纹理至对应图集，仅gpu纹理切换开销。</li></ul></li></ul><blockquote><p>此外理论上也可以预打一些图集，例如收集高频字体先打几张静态图集，更高频的放在前几张以求更高的cache命中率，减少gpu纹理切换的开销</p></blockquote><p>缺点：</p><ul><li>非htmltext，导致已有功能（例如字体阴影）不通用，带来较高迁移成本</li></ul><p>性能变化：</p><p>cpu满载-&gt;35%浮动，基本消除所有重绘重排，但内存消耗有所提升（纹理存储?）</p><p>线上：<a href="https://fe-perfcat.bilibili.co/utils/shorten/gPu9AN?runner=Runtime" target="_blank" rel="noreferrer">https://fe-perfcat.bilibili.co/utils/shorten/gPu9AN?runner=Runtime</a></p><figure><img src="/ayene-no-blog/assets/image-20250723144837252.DpbQq_G_.png" alt="image-20250723144837252" loading="lazy" decoding="async"></figure><p>webgl改造后：<a href="https://fe-perfcat.bilibili.co/utils/shorten/08JiOL?runner=Runtime" target="_blank" rel="noreferrer">https://fe-perfcat.bilibili.co/utils/shorten/08JiOL?runner=Runtime</a></p><figure><img src="/ayene-no-blog/assets/image-20250723144906546.DhvNhLcs.png" alt="image-20250723144906546" loading="lazy" decoding="async"></figure><p>源码部分：</p><p>HTMLText</p><div class="language-typescript"><button title="Copy code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 渲染阶段生成纹理</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">private async </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">_buildTexturePromise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(options: HTMLTextOptions)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">text</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">style</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">resolution</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">textureStyle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> options </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">            text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">            style</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> HTMLTextStyle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">            resolution</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">            textureStyle</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> TextureStyle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> htmlTextData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> BigPool.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(HTMLTextRenderData);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> fontFamilies</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> extractFontFamilies</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(text, style);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> fontCSS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getFontCss</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            fontFamilies,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            style,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            HTMLTextStyle.defaultTextStyle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">fontWeight</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">fontStyle</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        );</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> measured</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> measureHtmlText</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(text, style, fontCSS, htmlTextData);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> width</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">ceil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">ceil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">((Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, measured.width) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (style.padding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">))) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> resolution);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> height</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">ceil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">ceil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">((Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, measured.height) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (style.padding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">))) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> resolution);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> image</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> htmlTextData.image;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // this off set will ensure we don't get any UV bleeding!</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> uvSafeOffset</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        image.width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> uvSafeOffset;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        image.height </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (height </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">|</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> uvSafeOffset;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> svgURL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getSVGUrl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(text, style, resolution, fontCSS, htmlTextData);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> loadSVGImage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(image, svgURL, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">isSafari</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> fontFamilies.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">length</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> &gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> resource</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> HTMLImageElement</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> HTMLCanvasElement</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> image;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> canvasAndContext</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> CanvasAndContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._createCanvas)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            // silly webGPU workaround..</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            canvasAndContext </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getTemporaryCanvasFromImage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(image, resolution);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> texture</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> getPo2TextureFromSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(canvasAndContext </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">?</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> canvasAndContext.canvas </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> resource,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            image.width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> uvSafeOffset,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            image.height </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> uvSafeOffset,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            resolution</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        );</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (textureStyle) texture.source.style </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> textureStyle;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._createCanvas)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._renderer.texture.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">initSource</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(texture.source);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            CanvasPool.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">returnCanvasAndContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(canvasAndContext);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        BigPool.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(htmlTextData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> PoolItem</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> texture;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">// 测量文字宽高</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> measureHtmlText</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">    text</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">    style</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> HTMLTextStyle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">    fontStyleCSS</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">?:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">,</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">    htmlTextRenderData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">?:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> HTMLTextRenderData</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Size</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    htmlTextRenderData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">||=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> tempHTMLTextRenderData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (tempHTMLTextRenderData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> HTMLTextRenderData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">());</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">domElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">styleElement</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">svgRoot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> htmlTextRenderData;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    domElement.innerHTML </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> `&lt;style&gt;${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">style</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">cssStyle</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">};&lt;/style&gt;&lt;div style='padding:0'&gt;${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">text</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">}&lt;/div&gt;`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    domElement.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">setAttribute</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'style'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'transform-origin: top left; display: inline-block'</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (fontStyleCSS)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        styleElement.textContent </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> fontStyleCSS;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // Measure the contents using the shadow DOM</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    document.body.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">appendChild</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(svgRoot);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> contentBounds</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> domElement.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">getBoundingClientRect</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    svgRoot.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">remove</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">    // padding is included in the CSS calculation, so we need to remove it here</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> doublePadding</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> style.padding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        width: contentBounds.width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> doublePadding,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        height: contentBounds.height </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> doublePadding,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">}</span></span></code></pre><button class="code-block-unfold-btn"></button></div><p>BitmapText</p><div class="language-typescript"><button title="Copy code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code v-pre><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">   public </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">ensureCharacters</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(chars: string): </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">void</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> charList</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> CanvasTextMetrics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">graphemeSegmenter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(chars)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">char</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> !</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._currentChars.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">includes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(char))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">filter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">((</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">char</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70">self</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> self.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">indexOf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(char) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">===</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> index);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // filter returns..</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">charList.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._currentChars </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> [</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">...</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._currentChars, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">charList];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> pageData;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._currentPageIndex </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">===</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            pageData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">_nextPage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        else</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            pageData </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.pages[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._currentPageIndex];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> { canvas, context } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> pageData.canvasAndContext;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> textureSource </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> pageData.texture.source;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> style</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._style;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">				// uv-offset</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> currentX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._currentX;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> currentY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._currentY;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> currentMaxCharHeight </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._currentMaxCharHeight;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> fontScale</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.baseRenderedFontSize </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.baseMeasurementFontSize;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> padding</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._padding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> fontScale;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> skipTexture </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> maxTextureWidth</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> canvas.width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.resolution;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> maxTextureHeight</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> canvas.height </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.resolution;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">; i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> charList.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">; i</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">++</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> charList[i];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> metrics</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> CanvasTextMetrics.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">measureText</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(char, style, canvas, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            // override the line height.. we want this to be the glyps height</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            // not the user specified one.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            metrics.lineHeight </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> metrics.height;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> width</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> metrics.width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> fontScale;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            // This is ugly - but italics are given more space so they don't overlap</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> textureGlyphWidth</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">ceil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">((style.fontStyle </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">===</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> 'italic'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> ?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> :</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> width);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> height</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (metrics.height) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> fontScale;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> paddedWidth</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> textureGlyphWidth </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (padding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> paddedHeight</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> height </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (padding </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            skipTexture </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            // don't let empty characters count towards the maxCharHeight</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (char </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> char </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">\r</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> char </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> '</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">\t</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF">'</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> char </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">!==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF"> ' '</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                skipTexture </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                currentMaxCharHeight </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">ceil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">max</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(paddedHeight, currentMaxCharHeight));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">           // 计算uv-offset，先尝试向右写，超宽度就向下写</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (currentX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> paddedWidth </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> maxTextureWidth)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                currentY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> currentMaxCharHeight;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">                // reset the line x and height..</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                currentMaxCharHeight </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> paddedHeight;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                currentX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">              // 纹理页面被填满，创建新纹理</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (currentY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> currentMaxCharHeight </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> maxTextureHeight)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    textureSource.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> pageData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">_nextPage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    canvas </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> pageData.canvasAndContext.canvas;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    context </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> pageData.canvasAndContext.context;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    textureSource </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> pageData.texture.source;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    currentX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    currentY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    currentMaxCharHeight </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> xAdvance</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> fontScale)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (style.dropShadow?.distance </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">??</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (style._stroke?.width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">??</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">            // This is in coord space of the measurements.. not the texture</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">            this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.chars[char] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                id: char.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">codePointAt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                xOffset: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._padding,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                yOffset: </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._padding,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                xAdvance,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                kerning: {},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">            if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> (skipTexture)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">                this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">_drawGlyph</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    context,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    metrics,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    currentX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> padding,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    currentY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> padding,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    fontScale,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    style,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                );</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> px</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> textureSource.width </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> fontScale;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> py</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> textureSource.height </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> fontScale;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">                const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> frame</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Rectangle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    ((currentX) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> px) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> textureSource.width,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    ((currentY) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> py) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> textureSource.height,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    ((paddedWidth) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> px) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> textureSource.width,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    ((paddedHeight) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> py) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> textureSource.height,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                );</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">                this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.chars[char].texture </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0"> Texture</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    source: textureSource,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                    frame,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">                currentX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> Math.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">ceil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(paddedWidth);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">            }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">        textureSource.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._currentX </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> currentX;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._currentY </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> currentY;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._currentMaxCharHeight </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8"> currentMaxCharHeight;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D">        // now apply kerning..</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF">        this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">._skipKerning </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583">&amp;&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF"> this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0">_applyKerning</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">(charList, context);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8">    }</span></span></code></pre><button class="code-block-unfold-btn"></button></div><h3 id="播放器agent日志-开发中" tabindex="-1">播放器agent日志（开发中） <a class="header-anchor" href="#播放器agent日志-开发中" aria-label="Permalink to &quot;播放器agent日志（开发中）&quot;">​</a></h3><p>当前用户反馈较多，日志下载分析等流程繁琐，使用AI实现该任务分析处理简单客诉可以提高效率，主要以RAG执行具体任务</p><h4 id="_7-14-week1" tabindex="-1">7.14 week1 <a class="header-anchor" href="#_7-14-week1" aria-label="Permalink to &quot;7.14 week1&quot;">​</a></h4><figure><img src="/ayene-no-blog/assets/7d2fb796cbf57d047502b79af236f714.BENe7oag.png" alt="7d2fb796cbf57d047502b79af236f714" loading="lazy" decoding="async"></figure><h5 id="现状" tabindex="-1">现状 <a class="header-anchor" href="#现状" aria-label="Permalink to &quot;现状&quot;">​</a></h5><p>用户反馈问题 -&gt; 格式化问题 &amp; 提取问题重点 &amp; 提取用户MID（LLM） -&gt; 日志提取 （MCP）-&gt; LLM -&gt; 输出日志理解</p><p>虽然流程跑通了，但是问题有很多，目前主要是LLM部分使用的是b站自研，输入日志后完全无法理解日志内容（预期是虽然没有知识库，但是要能根据变量名猜测一下），需要一个外部llm的api-key。</p><h5 id="可改进点" tabindex="-1">可改进点 <a class="header-anchor" href="#可改进点" aria-label="Permalink to &quot;可改进点&quot;">​</a></h5><p>用户反馈问题 -&gt; 格式化问题 &amp; 提取问题重点 &amp; 提取用户MID（LLM） → <strong>prompt工程（优化用户问题描述）</strong> → 日志提取（MCP） -&gt; <strong>对日志进行一定解析</strong> → LLM (with <strong>RAG</strong>) -&gt; 输出日志理解</p><p>接下来尝试优先级</p><ol><li>先更换LLM</li><li>根据表现，尝试制作知识库完成RAG</li><li>prompt工程，日志解析后再输入等（例如先分割出哪一部分是内核，哪一部分是播放器，哪些是用户信息，浏览器信息…理论上给出更格式化的数据LLM的解析效果会更好）</li></ol><h4 id="_7-21-week2" tabindex="-1">7.21 week2 <a class="header-anchor" href="#_7-21-week2" aria-label="Permalink to &quot;7.21 week2&quot;">​</a></h4><p>一期目标：</p><p>目标：能够理解日志内容</p><ul><li><p>能够梳理清楚现有公司Copliot平台、MCP平台具备什么能力？</p></li><li><p>梳理缺乏的知识库内容+补充埋点，将知识库内容补齐</p></li><li><p>模型能够正确理解日志内容，输出用户的设备信息、浏览器信息、稿件信息等</p></li></ul><hr><p><strong>公司Copilot平台提供了目前制作agent需要的常见能力</strong></p><p>● 大模型基座能力：内部自研 or 需要api-key的外部模型</p><p>● 流程控制能力：提供workflow，状态管理</p><p>● RAG能力：</p><p>​ ○ 数据：可以自己输入知识库，包括本地文档、表格，info页面、腾讯文档等。</p><p>​ ○ chuking：支持部分自定义（重叠长度&amp;分块长度），但也有推荐行为，暂不清楚底层实现</p><p>● MCP能力：支持将云函数部署在公司平台，但是似乎不对公司其他平台有任何数据交互，例如若需要日志\埋点数据，需要自行编写爬虫函数。</p><hr><p><strong>TODO LIST：</strong></p><p>● RAG相关</p><p>方案1：人工制作以下文档</p><p>​ ○ 播放器基础知识</p><p>​ ○ 日志相关的模块文档</p><p>​ ○ 问题分析和解决方案（少部分demo）</p><p>方案2：</p><p>​ ○ 根据日志动态拉gitlab代码or干脆直接把代码做成知识库（log涉及65个文件，仅log.e涉及23个文件）</p><p>​ ○ 但是用外部模型有合规性风险</p><p>● 接口相关</p><p>​ ○ 目前拉取mid的方法需要登录fawkes平台，拿到cookie验证，cookie每天刷新很不方便（模拟扫码登录 or 联系fawkes平台？）</p><p>​ ○ 之后有可能需要垃埋点日志</p><p>● prompt相关：根据效果慢慢调，另外如果需要可以指定一个指定的输出schema</p><p>● 日志拆分</p><!--]--><!--]--><!----><!----></article><!-- </Transition> --><!--]--><!--[--><!--[--><!--[--><!----><ul class="post-copyright" m="y-4"><li class="post-copyright-author"><strong>本文作者：</strong><span>水沢绫音</span></li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://pat-chou-li.github.io/ayene-no-blog/posts/%E5%89%8D%E7%AB%AF/周记" target="_blank" title="本文链接">https://pat-chou-li.github.io/ayene-no-blog/posts/前端/周记</a></li><li class="post-copyright-license"><strong>版权声明：</strong><span>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 ">CC BY-NC-SA</a> 许可协议。</span></li></ul><!--]--><!--]--><!--]--></div><!--]--><!----></div><!--[--><!--]--><!--[--><div class="post-nav"><div class="post-nav-item"><a href="/ayene-no-blog/posts/%E9%9A%8F%E7%AC%94/LLM相关" class="post-nav-prev" title="LLM相关"><div class="icon" i-ri-arrow-left-s-line></div><span class="title truncate" text="sm">LLM相关</span></a></div><div class="post-nav-item"><a href="/ayene-no-blog/posts/%E5%89%8D%E7%AB%AF/周记（鹅）" class="post-nav-next" title="周记"><span class="title truncate" text="sm">周记</span><div class="icon" i-ri-arrow-right-s-line></div></a></div></div><!--]--><!--[--><!--]--><!----><!--[--><!-- eslint-disable-next-line vue/no-lone-template empty --><template class="mt-4"></template><!--]--><!--[--><!--]--><!--[--><!--]--></div><!--]--></main><!--[--><button class="xl:hidden toc-btn shadow-md fixed yun-icon-btn z-20 bg-$va-c-bg-soft" opacity="75" right="4" bottom="19"><div i-ri-file-list-line></div></button><!----><aside flex="~ col" class="va-card yun-aside sticky top-0 lg:top-$yun-margin-top min-h-sm" text="center" overflow="auto"><div style="display:none" class="w-full" flex="~ col" pb-2><!--[--><h2 m="t-6 b-2" font="serif black">文章目录</h2><div style="display:none" data-v-6dc67c73><div class="content" data-v-6dc67c73><div class="outline-title" data-v-6dc67c73>本页</div><div class="outline-marker" data-v-6dc67c73></div><nav aria-labelledby="doc-outline-aria-label" data-v-6dc67c73><span id="doc-outline-aria-label" class="visually-hidden" data-v-6dc67c73>Table of Contents for current page</span><ul class="root va-toc relative z-1 css-i18n-toc" data-v-6dc67c73 data-v-699db71a><!--[--><!--]--></ul></nav></div></div><!--]--><div class="flex-grow"></div><!----></div></aside><!--]--><!--]--></div><footer flex="~ col" class="relative yun-footer va-footer px-4 py-4 pt-0 text-$va-c-text-light w-full mt-14" bg="white dark:$va-c-bg-soft" text="center sm"><div class="yun-cloud absolute top--10 left-0 right-0"><svg class="waves" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" fill="var(--yun-c-cloud)"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><!----><div class="copyright flex justify-center items-center gap-2" p="1"><span>©<!--[--> 2022 -<!--]--> 2025</span><a class="animate-pulse inline-flex" href="https://www.yunyoujun.cn/sponsors/" target="_blank" title="Sponsor YunYouJun"><div class="i-ri-cloud-line"></div></a><span>水沢绫音</span></div><div class="powered" m="2"><span>由 <a href="git+https://github.com/YunYouJun/valaxy.git" target="_blank" rel="noopener">Valaxy</a> <span class="op-60">v0.26.3</span> 驱动</span><span mx-1>|</span><span><span>主题</span><span mx-1>-</span><a href="git+https://github.com/YunYouJun/valaxy/tree/main/packages/valaxy-theme-yun.git" title="valaxy-theme-yun" target="_blank">Yun</a><span class="ml-1 op-60">v0.26.3</span></span></div><!--[--><!--]--><div class="yun-footer-gradient" style="--gradient-from:161 196 253;--gradient-to:194 233 251"></div></footer><!--]--><!--]--></div><script>window.__INITIAL_STATE__='{"pinia":{"yun-app":{},"app":{"showLoading":true},"site":{},"routerStore":{}}}'</script><script type="application/ld+json" data-hid="schema-org-graph">{"@context":"https://schema.org","@graph":[{"@id":"https://pat-chou-li.github.io/ayene-no-blog/#identity","@type":"Person","name":"水沢绫音","url":"https://pat-chou-li.github.io/ayene-no-blog/","image":{"@id":"https://pat-chou-li.github.io/ayene-no-blog/#/schema/image/658d95f"},"sameAs":["/atom.xml","https://github.com/pat-chou-li","https://www.zhihu.com/people/shui-ze-ling-yin-46","https://space.bilibili.com/8929945?spm_id_from=333.1007.0.0","patchouli13@163.com"]},{"@id":"https://pat-chou-li.github.io/ayene-no-blog/#website","@type":"WebSite","dateModified":"2025-08-22T09:02:38.871Z","datePublished":"2025.4.23","inLanguage":"en","name":"周记","url":"https://pat-chou-li.github.io/ayene-no-blog/","publisher":{"@id":"https://pat-chou-li.github.io/ayene-no-blog/#identity"}},{"@id":"https://pat-chou-li.github.io/ayene-no-blog/#webpage","@type":"WebPage","dateModified":"2025-08-22T09:02:38.871Z","datePublished":"2025-04-23T00:00:00.000Z","description":"我从来没有觉得学图形学开心过。","name":"周记","url":"https://pat-chou-li.github.io/ayene-no-blog/","about":{"@id":"https://pat-chou-li.github.io/ayene-no-blog/#identity"},"isPartOf":{"@id":"https://pat-chou-li.github.io/ayene-no-blog/#website"},"potentialAction":[{"@type":"ReadAction","target":["https://pat-chou-li.github.io/ayene-no-blog/"]}]},{"@id":"https://pat-chou-li.github.io/ayene-no-blog/#article","dateModified":"2025-08-22T09:02:38.871Z","datePublished":"2025-04-23T00:00:00.000Z","description":"我从来没有觉得学图形学开心过。","headline":"周记","inLanguage":"en","thumbnailUrl":"https://pat-chou-li.github.io/ayene-no-blog/favicon.svg","@type":["Article","BlogPosting"],"author":{"@id":"https://pat-chou-li.github.io/ayene-no-blog/#/schema/person/6678b6b"},"image":{"@id":"https://pat-chou-li.github.io/ayene-no-blog/#/schema/image/19d7713"},"isPartOf":{"@id":"https://pat-chou-li.github.io/ayene-no-blog/#webpage"},"mainEntityOfPage":{"@id":"https://pat-chou-li.github.io/ayene-no-blog/#webpage"},"publisher":{"@id":"https://pat-chou-li.github.io/ayene-no-blog/#identity"}},{"@id":"https://pat-chou-li.github.io/ayene-no-blog/#/schema/person/6678b6b","@type":"Person","name":"水沢绫音","url":"https://valaxy.site"},{"@id":"https://pat-chou-li.github.io/ayene-no-blog/#/schema/image/658d95f","@type":"ImageObject","contentUrl":"https://raw.githubusercontent.com/pat-chou-li/ayene-no-blog/main/resource/avatar.jpg","inLanguage":"en","url":"https://raw.githubusercontent.com/pat-chou-li/ayene-no-blog/main/resource/avatar.jpg"},{"@id":"https://pat-chou-li.github.io/ayene-no-blog/#/schema/image/19d7713","@type":"ImageObject","contentUrl":"https://pat-chou-li.github.io/ayene-no-blog/favicon.svg","inLanguage":"en","url":"https://pat-chou-li.github.io/ayene-no-blog/favicon.svg"}]}</script></body></html>